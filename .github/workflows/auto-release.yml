name: Auto Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Version from Manifest
        id: version
        run: |
          # Read version from manifest.json
          version=$(jq -r .version custom_components/system_nexa_2/manifest.json)
          echo "Detected version from manifest: $version"
          
          # Check if tag already exists to prevent duplicate release failure
          if git rev-parse "v$version" >/dev/null 2>&1; then
             echo "Tag v$version already exists. Assuming re-run or patch."
             # Optional: fail or just continue? 
             # For now, let's just proceed, gh-release might warn but that's ok.
          fi
          
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "tag=v$version" >> $GITHUB_OUTPUT

      - name: Create ZIP file
        run: |
          cd custom_components/system_nexa_2
          zip -r ../../system_nexa_2.zip .
          
          # Debug: Verify zip content (should be flat)
          unzip -l ../../system_nexa_2.zip

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          draft: false
          prerelease: false
          files: system_nexa_2.zip
          body: |
            Automated Alpha Release ${{ steps.version.outputs.tag }}
            
            **Changes in this release:**
            ${{ github.event.head_commit.message }}
